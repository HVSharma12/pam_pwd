- name: RHEL 7 Keep history of the last {{ pam_pwd_history }} passwords used.
  lineinfile:
    path: "{{ item }}"
    insertafter: '^.*pam_pwquality.so.*$'
    line: >-
      password    requisite     pam_pwhistory.so remember={{ pam_pwd_history }}
      use_authtok
    state: present
    backup: yes
  with_items:
    - /etc/pam.d/system-auth
    - /etc/pam.d/password-auth

- name: RHEL 7 Configure pam_faillock.so
  lineinfile:
    path: "{{ item }}"
    insertbefore: '^account.*$'
    firstmatch: yes
    line: account     required      pam_faillock.so
    state: present
    backup: yes
  with_items:
    - /etc/pam.d/system-auth
    - /etc/pam.d/password-auth

- name: RHEL 7 configure pam_faillock.so for preauth
  lineinfile:
    path: "{{ item }}"
    insertafter: '^.*pam_env.so.*$'
    firstmatch: yes
    line: >-
      auth        required      pam_faillock.so preauth silent audit
      deny={{ pam_pwd_deny }} unlock_time={{ pam_pwd_unlock_time }}
    state: present
    backup: yes
  with_items:
    - /etc/pam.d/system-auth
    - /etc/pam.d/password-auth

- name: RHEL 7 configure pam_faillock.so for authfail
  lineinfile:
    path: "{{ item }}"
    insertafter: ^auth.*sufficient.*pam_unix\.so.*nullok.*try_first_pass.*$
    firstmatch: yes
    line: >-
      auth        [default=die]      pam_faillock.so authfail audit
      deny={{ pam_pwd_deny }} unlock_time={{ pam_pwd_unlock_time }}
    state: present
    backup: yes
  with_items:
    - /etc/pam.d/system-auth
    - /etc/pam.d/password-auth

- name: RHEL 7 Enforce root for password complexity
  lineinfile:
    path: "{{ item }}"
    regexp: >
      ^password.*requisite.*pam_pwquality\.so.*try_first_pass.*local_users_only
      .*retry=3.*authtok_type=.*$
    line: >
      password    requisite     pam_pwquality.so try_first_pass local_users_only
      retry=3 authtok_type= {{ pam_pwd_enforce_root }}
    state: present
    backup: yes
  with_items:
    - /etc/pam.d/system-auth
    - /etc/pam.d/password-auth
  when:
    - pam_pwd_enforce_root is defined
    - pam_pwd_enforce_root|length > 0
